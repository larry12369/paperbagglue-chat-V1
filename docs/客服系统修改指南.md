# 客服系统修改指南

## 📋 目录
1. [系统架构概览](#系统架构概览)
2. [修改流程总览](#修改流程总览)
3. [各功能模块修改指南](#各功能模块修改指南)
4. [常见修改场景](#常见修改场景)
5. [测试与部署](#测试与部署)

---

## 🏗️ 系统架构概览

```
┌─────────────────────────────────────────────────────────┐
│                    客服系统架构                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  前端 (浏览器)                                          │
│  ├── chat-widget.js     ← 聊天组件UI和交互              │
│  └── embed-code.js      ← 网站嵌入代码                  │
│                                                          │
│  ↓ HTTP API                                            │
│                                                          │
│  后端服务器 (Flask)                                     │
│  ├── app.py              ← API接口                      │
│  │   ├── /api/chat      ← 聊天接口                      │
│  │   ├── /api/upload    ← 文件上传接口                  │
│  │   └── /static/*      ← 静态文件服务                  │
│  └── agents/             ← Agent逻辑                    │
│      └── agent.py        ← LangChain Agent              │
│                                                          │
│  ↓                                                    │
│                                                          │
│  外部服务                                               │
│  ├── Doubao大模型         ← AI对话生成                 │
│  ├── 对象存储             ← 图片存储                   │
│  └── 飞书多维表格         ← 数据保存                   │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 修改流程总览

### 完整修改流程

```
┌─────────────────────────────────────────────────────────┐
│  第一步：明确修改需求                                    │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  第二步：确定修改范围                                    │
│  ┌──────────────┬──────────────┬──────────────┐        │
│  │ 前端UI修改   │ 后端逻辑修改 │ 配置修改     │        │
│  └──────────────┴──────────────┴──────────────┘        │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  第三步：定位代码位置                                    │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  第四步：修改代码                                        │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  第五步：测试验证                                        │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  第六步：部署更新                                        │
└─────────────────────────────────────────────────────────┘
```

---

## 📂 各功能模块修改指南

### 1️⃣ 前端UI修改

#### 📍 修改文件位置
```
src/api/static/chat-widget.js
```

#### 🎨 可修改的内容

| 功能 | 修改位置 | 说明 |
|------|---------|------|
| 聊天按钮样式 | `createWidgetCSS()` 中的 `#chat-toggle-btn` | 颜色、大小、位置 |
| 聊天窗口样式 | `createWidgetCSS()` 中的 `#chat-window` | 尺寸、阴影、圆角 |
| 头部样式 | `createWidgetCSS()` 中的 `.chat-header` | 高度、背景色、字体 |
| 消息样式 | `createWidgetCSS()` 中的 `.message-content` | 气泡样式、颜色 |
| 欢迎消息 | `createWidgetHTML()` 中的 `#welcome-message` | 文本内容 |
| 按钮文字 | `createWidgetHTML()` 中的 `<span>` 标签 | "咨询" → "Consult" |
| 自动打开延迟 | `CONFIG` 中的 `AUTO_OPEN_DELAY` | 3000 = 3秒 |

#### 🔧 修改示例

**示例1：修改欢迎消息**
```javascript
// 在 createWidgetHTML() 函数中找到欢迎消息部分
// 原始内容：
<p>您好！我是河北鑫邦包装材料有限公司的销售经理 Larry Chen。👋</p>

// 修改为：
<p>Hello! I'm Larry Chen from Xinbang Packaging. How can I help you today? 👋</p>
```

**示例2：修改自动打开时间**
```javascript
// 在文件开头的 CONFIG 对象中
const CONFIG = {
  AUTO_OPEN_DELAY: 5000,  // 修改为5秒
  // ...
};
```

**示例3：修改聊天按钮颜色**
```javascript
// 在 createWidgetCSS() 函数中找到 #chat-toggle-btn
// 原始：
background: linear-gradient(135deg, #00A859 0%, #008F4D 100%) !important;

// 修改为蓝色：
background: linear-gradient(135deg, #007AFF 0%, #0056B3 100%) !important;
```

---

### 2️⃣ 后端API修改

#### 📍 修改文件位置
```
src/api/app.py
```

#### 🎨 可修改的内容

| 功能 | 修改位置 | 说明 |
|------|---------|------|
| 新增API接口 | 添加新的 `@app.route()` | 新功能接口 |
| 修改API逻辑 | 修改路由处理函数 | 改变业务逻辑 |
| 添加文件类型支持 | `upload_file()` 函数 | 支持更多格式 |
| 修改存储逻辑 | `save_chat_to_feishu()` | 改变数据结构 |
| 添加错误处理 | try-except 块 | 优化错误提示 |

#### 🔧 修改示例

**示例1：修改上传文件大小限制**
```python
# 在 upload_file() 函数中添加
@app.route('/api/upload', methods=['POST'])
def upload_file():
    # 添加文件大小限制（例如：10MB）
    MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB
    
    file = request.files['file']
    file.seek(0, os.SEEK_END)
    file_size = file.tell()
    file.seek(0)
    
    if file_size > MAX_FILE_SIZE:
        return jsonify({'error': 'File too large. Max 10MB.'}), 400
    
    # 继续处理...
```

**示例2：添加新的API接口**
```python
# 在 app.py 中添加新路由
@app.route('/api/customer-info', methods=['POST'])
def save_customer_info():
    """保存客户信息"""
    data = request.json
    name = data.get('name')
    email = data.get('email')
    
    # 保存到飞书
    save_customer_to_feishu(name, email)
    
    return jsonify({'success': True})
```

---

### 3️⃣ Agent逻辑修改

#### 📍 修改文件位置
```
src/agents/agent.py          ← Agent主逻辑
config/agent_llm_config.json ← 配置和提示词
```

#### 🎨 可修改的内容

| 功能 | 修改位置 | 说明 |
|------|---------|------|
| AI回复风格 | `agent_llm_config.json` 的 `sp` 字段 | 系统提示词 |
| 工具配置 | `agent_llm_config.json` 的 `tools` 字段 | 可用工具列表 |
| 模型参数 | `agent_llm_config.json` 的 `config` 字段 | 温度、tokens等 |
| 消息记忆长度 | `agent.py` 中的 `MAX_MESSAGES` | 对话轮数 |

#### 🔧 修改示例

**示例1：修改AI的回复风格（系统提示词）**
```json
// 在 config/agent_llm_config.json 中
{
  "sp": "你是一个专业的纸袋胶水销售专家。你的特点是：
1. 专业、友善、热情
2. 主动了解客户需求
3. 提供具体的产品推荐
4. 引导客户留下联系方式
请用简洁、专业的英语回答。",
  // ...
}
```

**示例2：修改对话记忆长度**
```python
# 在 src/agents/agent.py 中

# 默认保留最近 20 轮对话 (40 条消息)
MAX_MESSAGES = 40  # 修改为40轮
```

**示例3：修改模型参数**
```json
// 在 config/agent_llm_config.json 中
{
  "config": {
    "model": "doubao-seed-1-6-251015",
    "temperature": 0.9,  // 提高创造性（0-1之间）
    "top_p": 0.95,
    "max_completion_tokens": 2000,  // 增加回复长度
    "timeout": 600
  }
}
```

---

## 📋 常见修改场景

### 场景1：修改欢迎语

**步骤：**
1. 打开 `src/api/static/chat-widget.js`
2. 搜索 `welcome-message`
3. 修改HTML内容
4. 保存文件
5. 推送到Render

### 场景2：修改自动打开时间

**步骤：**
1. 打开 `src/api/static/chat-widget.js`
2. 找到 `CONFIG` 对象
3. 修改 `AUTO_OPEN_DELAY` 值
4. 保存文件
5. 推送到Render

### 场景3：修改AI回复风格

**步骤：**
1. 打开 `config/agent_llm_config.json`
2. 修改 `sp` 字段（系统提示词）
3. 保存文件
4. 推送到Render
5. 重启Render服务

### 场景4：修改产品链接

**步骤：**
1. 打开 `config/agent_llm_config.json`
2. 在 `sp` 字段中添加产品链接说明
3. 保存文件
4. 推送到Render
5. 重启Render服务

### 场景5：添加新的工具功能

**步骤：**
1. 在 `src/tools/` 下创建新工具文件
2. 实现工具函数（使用 `@tool` 装饰器）
3. 在 `src/agents/agent.py` 中注册工具
4. 在 `config/agent_llm_config.json` 的 `tools` 中添加工具名称
5. 推送到Render
6. 重启Render服务

---

## 🧪 测试与部署

### 本地测试流程

```bash
# 1. 修改代码后，先在本地测试
cd /workspace/projects
python src/main.py

# 2. 测试API接口
curl -X POST http://localhost:5000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "test"}'

# 3. 测试静态文件
curl http://localhost:5000/static/chat-widget.js
```

### 部署到Render

```bash
# 1. 提交代码到Git
git add .
git commit -m "修改说明"
git push

# 2. Render自动检测更新并重新部署

# 3. 查看部署日志
# 在Render控制台查看实时日志
```

### 验证修改是否生效

1. **前端修改**：
   - 刷新浏览器页面（Ctrl+F5）
   - 清除缓存后重新加载

2. **后端修改**：
   - 查看Render日志确认服务重启
   - 测试API接口

3. **Agent修改**：
   - 发送测试消息验证AI回复
   - 检查是否符合预期风格

---

## 📝 修改检查清单

修改前检查：
- [ ] 明确修改需求
- [ ] 确定修改范围（前端/后端/配置）
- [ ] 备份原文件
- [ ] 了解代码结构

修改时注意：
- [ ] 保持代码风格一致
- [ ] 添加必要注释
- [ ] 测试所有相关功能
- [ ] 检查错误处理

修改后验证：
- [ ] 功能正常工作
- [ ] 没有控制台错误
- [ ] 兼容移动端
- [ ] 更新文档（如需要）

---

## 🚨 常见问题

### Q1: 修改后没有生效？
**A**: 
1. 检查是否保存了文件
2. 检查是否推送到Render
3. 清除浏览器缓存
4. 查看Render日志

### Q2: 如何回滚修改？
**A**: 
```bash
# 回滚到上一个版本
git log --oneline  # 查看提交历史
git reset --hard HEAD~1  # 回退一个版本
git push -f  # 强制推送
```

### Q3: 修改导致报错怎么办？
**A**: 
1. 查看Render日志获取错误信息
2. 使用 `git diff` 查看修改内容
3. 回滚到上一个版本
4. 重新分析问题

### Q4: 如何添加新的功能？
**A**: 
1. 先创建TODO列表规划步骤
2. 按模块逐步实现
3. 每完成一个功能就测试一次
4. 最后整体测试

---

## 📞 需要帮助？

如果您在修改过程中遇到问题，可以：
1. 查看Render日志定位错误
2. 检查相关文件的注释说明
3. 参考本文档的示例代码
4. 联系技术支持

---

## 📚 相关文档

- [Flask官方文档](https://flask.palletsprojects.com/)
- [LangChain文档](https://python.langchain.com/)
- [Render部署指南](https://render.com/docs)
- [飞书开放平台](https://open.feishu.cn/)

---

**最后更新**: 2025-01-18
**版本**: 2.0
